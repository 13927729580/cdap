defaultTasks 'build'

task cleanbuild(type: Exec, description: 'Remove all files from ./build/') {
	commandLine = ['rm', '-rf', './build']
}

task syntax(type: Exec, description: 'runs jshint on all non-test and lib JS files') {
	
	// Uses jshint.json configuration file
	// Uses .jshintignore for exceptions

/*for (p in project.getProperties()) {
	println("***** " + p);
} */
	
	commandLine = ["./tools/jshint/bin/hint", 
		"./client/js/models/", "./client/js/views/", "./client/js/controllers/", "./client/js/",
		"./server/", "--config", 'jshint.json']
}

//task link() {
//	"npm link ./server/".execute();
//	"rm -rf ./node_modules/".execute();
//}

task binaries (type: Copy) {
	from 'bin/'
	into 'build/bin'
}

task server(type:Copy, dependsOn: 'syntax', description: 'Copies relevant server files to build') {
	from 'server/'
	into 'build/server'
}
server.configure {
	include('bin/*', 'package.json', 'node_modules/**/*', 'thrift_bindings/**/*', 'api.js', 'env.js', 'main.js', 'index.html')
}

task templates(type:Copy, dependsOn: 'syntax') {
    from 'client/templates/'
    into 'build/client/templates/'
}

task jsraw(type:Copy, dependsOn: 'templates') {
    from 'client/js/'
    into 'build/client/js/'
}

task js(type: Exec, dependsOn: 'syntax', description: 'Combines and minifies JS') {
	
	// Uses app.build.js configuration file
	"mkdir ./build/client".execute()
	"mkdir ./build/client/js".execute()
	commandLine = ['./tools/requirejs/bin/r.js', '-o', 'app.build.js']

}

task jslibs(type:Copy) {
    from 'client/js/lib'
    into 'build/client/js/lib'
}

task css(type: Exec, dependsOn: 'js', description: 'Process and minify LESS -> CSS') {
	"mkdir ./build/client/css".execute()
	commandLine = ['cp', '-r', './client/css', './build/client/']
}

task images(type:Copy) {
    from 'client/img'
    into 'build/client/img'
}

task tests(type: Exec, dependsOn: 'css', description: 'Run tests in a headless browser environment') {
	
	// Pulled from https://github.com/detro/phantomjs-jasminexml-example
	commandLine = ['phantomjs', './tests/runner.js', './tests/runner.html', './tests/output.xml']
}

task docs(type: Exec, dependsOn: 'css', description: 'Generates Groc documentation') {
	
	// Uses .groc.json configuration file
    commandLine = ['./tools/groc']
}
// disabling docs for now due to issue with groc/pygmentize 
docs.enabled = false

task upload(type: Exec, dependsOn: 'docs', description: 'Uploads to webserver') {
    commandLine = ['./upload.sh']
}

//task build(overwrite: true, dependsOn: ['cleanbuild', 'syntax', 'server', 'js', 'jslibs', 'css', 'images', 'docs']) {
task build(overwrite: true, dependsOn: ['cleanbuild', 'server', 'jsraw', 'jslibs', 'css', 'images', 'docs']) {
	doLast {
		println "Done!"
	}
}

task run (type: Exec, dependsOn: ['build']) {
	commandLine = ['node', 'build/server/main.js']
}

task deploy(dependsOn: ['build', 'upload']) {
	doLast {
		println "Deployed!"
	}
}

/**
 * Create Release TAR ball - overwrite global task
 * 
 */
task release (type:  Tar, overwrite: true, dependsOn: build ) << {
    group = 'Continuuity'
    description = 'Generates distribution tar file.'

    /** Set the compression to gzip */
    compression = Compression.GZIP

    release.baseName = "web_cloud_app"

    from('build/client') {
        into("${release.baseName}-${project.version}/web-app/client")
    }

    from('build/server') {
        into("${release.baseName}-${project.version}/web-app/server")
    }

    from('conf') {
        into("${release.baseName}-${project.version}/conf")
    }
    println " NEW release task"
}

task upload_release (overwrite: true, dependsOn: release) << {
    //placeholder
}
task distro (overwrite: true, dependsOn: upload_release) << {
    //placeholder
}

