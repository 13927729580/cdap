
defaultTasks 'build'

task wrapper(type: Wrapper) {
	gradleVersion = '1.0-milestone-5'
}

task cleanbuild(type: Exec, description: 'Remove all files from ./build/') {
	commandLine = ['rm', '-rf', './build/*']
}

task syntax(type: Exec, description: 'runs jshint on all non-test and lib JS files') {
	
	// Uses jshint.json configuration file
	// Uses .jshintignore for exceptions
	commandLine = ["./tools/jshint/bin/hint", 
		"./client/js/models/", "./client/js/views/", "./client/js/controllers/", "./client/js/",
		"./server/", "--config", 'jshint.json']
}

task binaries(type:Copy) {
	from 'bin/'
	into 'build/bin'
}

//task link() {
//	"npm link ./server/".execute();
//	"rm -rf ./node_modules/".execute();
//}

task server(type:Copy, dependsOn: 'syntax', description: 'Copies relevant server files to build') {
	from 'server/'
	into 'build/server'
}
server.configure {
	include('bin/*', 'package.json', 'node_modules/**/*', 'thrift_bindings/**/*', 'api.js', 'env.js', 'main.js', 'index.html')
}

task js(type: Exec, dependsOn: 'syntax', description: 'Combines and minifies JS') {
	
	// Uses app.build.js configuration file
	"mkdir ./build/client".execute()
	"mkdir ./build/client/js".execute()
	commandLine = ['./tools/requirejs/bin/r.js', '-o', 'app.build.js']

}

task jslibs(type:Copy, dependsOn: 'js') {
    from 'client/js/lib'
    into 'build/client/js/lib'
}

task css(type: Exec, dependsOn: 'js', description: 'Process and minify LESS -> CSS') {
	"mkdir ./build/client/css".execute()
	commandLine = ['cp', '-r', './client/css', './build/client/']
}

task images(type:Copy) {
    from 'client/img'
    into 'build/client/img'
}

task tests(type: Exec, dependsOn: 'css', description: 'Run tests in a headless browser environment') {
	
	// Pulled from https://github.com/detro/phantomjs-jasminexml-example
	commandLine = ['phantomjs', './tests/runner.js', './tests/runner.html', './tests/output.xml']
}

task docs(type: Exec, dependsOn: 'css', description: 'Generates Groc documentation') {
	
	// Uses .groc.json configuration file
    commandLine = ['./tools/groc']
}
// disabling docs for now due to issue with groc/pygmentize 
docs.enabled = false

task upload(type: Exec, dependsOn: 'docs', description: 'Uploads to webserver') {
    commandLine = ['./upload.sh']
}

task build(overwrite: true, dependsOn: ['cleanbuild', 'binaries', 'syntax', 'server', 'js', 'jslibs', 'css', 'images', 'docs']) {
	doLast {
		println "Done!"
	}
}

task deploy(dependsOn: ['build', 'upload']) {
	doLast {
		println "Deployed!"
	}
}


