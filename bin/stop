#!/usr/bin/env bash

# Copyright (c) to Continuuity Inc. All rights reserved.

NAME=`basename $0`

if [[ "X$NAME" == "Xstart" ]]; then
  echo "Create a soft link to this script as stop-<component>-<service>"
  echo "E.g. ln -s stop-flow-far bin/start"
  exit 1
fi

APP=`echo $NAME | awk -F"-" ' { print $2 } '`
SERVICE=`echo $NAME | awk -F"-" ' { print $3 }'`

if [ ! -n "$CONTINUUITY_HOME" ]; then
  echo "CONTINUUITY_HOME is not set. Please set it."
  exit 1
fi

COMMON_BIN="$CONTINUUITY_HOME"/bin
if [ ! -d "$COMMON_BIN" ]; then
 if [ -d "$CONTINUUITY_HOME"/common/bin ]; then
   COMMON_BIN="$CONTINUUITY_HOME"/common/bin
 fi
fi

# Load comman.sh
source $COMMON_BIN/common.sh

# Load common environment file too
source $COMMON_BIN/common-env.sh

# Set the app home.
APP_HOME="$CONTINUUITY_HOME"/"$APP"

# Load app specific configuration.
SERVICE_ENVIRONMENT_FILE="$APP_HOME"/conf/"$SERVICE"-env.sh
if [ -f "$SERVICE_ENVIRONMENT_FILE" ]; then 
 . "$SERVICE_ENVIRONMENT_FILE"
fi

export LOG_PREFIX=$SERVICE-$IDENT_STRING-$HOSTNAME
export LOGFILE=$LOG_PREFIX.log
loglog="${LOG_DIR}/${LOGFILE}"

pid=$PID_DIR/$SERVICE-${IDENT_STRING}.pid
loggc=$LOG_DIR/$LOG_PREFIX.gc

if [ -f $pid ]; then
  pidToKill=`cat $pid`
  # kill -0 == see if the PID exists
  if kill -0 $pidToKill > /dev/null 2>&1; then
    echo -n stopping $command
    echo "`date` Terminating $command" >> $loglog
    kill $pidToKill > /dev/null 2>&1
    while kill -0 $pidToKill > /dev/null 2>&1;
    do
      echo -n "."
      sleep 1;
    done
    rm $pid
    echo
  else
    retval=$?
    echo nothing to stop because kill -0 of pid $pidToKill failed with status $retval
  fi
  rm -f $pid
else
  echo nothing to stop because no pid file $pid
fi
