apply from: "$rootProject.projectDir/gradle/framework.gradle"

// TODO: externalize.
project.ext {
    appHome = "${buildDir}/continuuity-developer-suite-1.6.0-SNAPSHOT"
}

task cleanDevSuite(type: Delete) {
    logger.println('[INFO]: Deleting previous Reactor...')
    delete "${buildDir}"
}

task deployDevSuite(type: Copy) {
    println "${rootProject.projectDir}"
    def zipFile = file("${rootProject.projectDir}/../distributions/build/distributions/continuuity-developer-suite-1.6.0-SNAPSHOT.zip")
    def outputDir = file("${buildDir}")

    from zipTree(zipFile)
    into outputDir
}

deployDevSuite.dependsOn 'cleanDevSuite'

//task collectJars << {
//    // Collect all examples jars
//    tree = fileTree(dir: "${appHome}/examples", include: '**/*.jar', exclude: ['**/lib/**', '**/lib-to-package/**'])
//    tree.each {File file ->
//        println file.absolutePath
//    }
//
//}

task startReactor << {
    command = ["${project.ext.appHome}/bin/continuuity-reactor start"]

    if (executeCommand(command) != 0) {
        throw new GradleScriptException("[ERROR] Unable to start reactor.", null)
    }
    else {
        logger.println('[INFO]: Reactor started.')
    }

    logger.println 'Waiting for instance startup...'
    sleep(5000)
    logger.println 'Reactor ready.'
}


task stopReactor << {
    command = ["${project.ext.appHome}/bin/continuuity-reactor stop"]

    if (executeCommand(command) != 0) {
        throw new GradleScriptException("[ERROR]: Unable to stop reactor", null)
    }
    else {
        logger.println('[INFO]: Reactor stopped.')
    }
}

// Clear all data from reactor
task cleanReactor(type: Delete) << {
    delete "${project.ext.appHome}/data"
}


task compileApps << {
    command = ["ant -f ${appHome}/examples/build.xml"]

    if (executeCommand(command) != 0) {
        throw new GradleScriptException("[ERROR]: Unable to build examples: ${command}", null)
    }
    else {
        logger.println('[INFO]: Example apps compiled.')
    }
}

task deployApps  {
    // Collect all examples jars
    tree = fileTree(dir: "${appHome}/examples", include: '**/*.jar', exclude: ['**/lib/**', '**/lib-to-package/**'])

    tree.each {File file ->
        println file.absolutePath
        command = ["${project.ext.appHome}/bin/reactor-client deploy --archive  ${file.absolutePath}"]

        if (executeCommand(command) != 0) {
            throw new GradleScriptException("[ERROR]: ${command}", null)
        }
        else {
            logger.println("[INFO]: Applications deployed: ${file.absolutePath}")
        }
    }
}

task startApps << {
    command = ["${projectDir}/bin/start-stop.sh start ${project.ext.appHome}"]

    if (executeCommand(command) != 0) {
        throw new GradleScriptException("[ERROR]: Unable to start applications. Command: $deploy", null)
    }
    else {
        logger.println('[INFO]: Applications deployed.')
    }
}


task testCmdLine << {
    // dependsOn: [deployDevSuite, startReactor, compileExamples, deployApps, startApps]
    BuildLogger.println('Testing command line suite..')

    doLast {
        stopReactor.execute()
    }
}









